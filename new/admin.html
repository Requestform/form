<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>音楽リクエスト管理</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #e8e8e8;
      color: #333;
    }
    .header {
      background-color: #1a1a1a;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .header h1 { font-size: 1.75rem; }

    #loginScreen {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .login-box {
      background: white;
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      max-width: 400px;
      width: 100%;
    }
    .login-box h2 { margin-bottom: 24px; color: #1a1a1a; }
    .login-box input {
      width: 100%;
      padding: 12px;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 16px;
    }
    .login-box input:focus { outline: none; border-color: #0f62fe; }
    .login-box button {
      width: 100%;
      padding: 12px;
      background: #0f62fe;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }
    .login-box button:hover { background: #0353e9; }
    .login-error { color: #a3261e; margin-bottom: 16px; }

    #adminContent { display: none; }
    #adminContent.visible { display: block; }

    .container {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px;
    }

    .section {
      background: white;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .section h2 { margin-bottom: 16px; color: #0f62fe; font-size: 1.25rem; }

    table {
      width: 100%;
      border-collapse: collapse;
    }
    th {
      background-color: #f3f3f3;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #d0d0d0;
    }
    td {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }
    tr:nth-child(odd) { background-color: #f9f9f9; }
    tr:nth-child(even) { background-color: white; }
    tr.played { opacity: 0.6; }
    tr.played td { background-color: #f0f0f0; }

    button.action-btn {
      padding: 6px 12px;
      background: #24a148;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
    }
    button.action-btn:hover { background: #1f8e3d; }
    button.action-btn:disabled { background: #8d8d8d; cursor: not-allowed; }

    button.delete-btn {
      padding: 6px 12px;
      background: #da1e28;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 4px;
      transition: background 0.2s;
    }
    button.delete-btn:hover { background: #a71d21; }
    button.delete-btn:disabled { background: #8d8d8d; cursor: not-allowed; }

    .status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-pending { background: #d1f4dd; color: #0c6a3c; }
    .status-played { background: #e8e8e8; color: #555; }

    /* YouTube link */
    .youtube-link {
      display: inline-block;
      padding: 6px 12px;
      background: #ff0000;
      color: white;
      border-radius: 4px;
      text-decoration: none;
      font-weight: 600;
      font-size: 12px;
      transition: background 0.2s;
      cursor: pointer;
    }
    .youtube-link:hover { background: #cc0000; }

    .empty-msg { text-align: center; color: #999; padding: 24px; }

    /* Spinner */
    .spinner-inline { width: 24px; height: 24px; border: 3px solid #d9d9d9; border-top-color: #0f62fe; border-radius: 50%; animation: spin 1s linear infinite; margin: 12px auto; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .header h1 { font-size: 1.5rem; }
      table { font-size: 12px; }
      td, th { padding: 8px; }
      button.action-btn { padding: 4px 8px; font-size: 11px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>🎵 音楽リクエスト管理画面</h1>
  </div>

  <!-- Login Screen -->
  <div id="loginScreen">
    <div class="login-box">
      <h2>管理者ログイン</h2>
      <div id="loginError" class="login-error"></div>
      <input type="password" id="adminPassword" placeholder="パスワードを入力">
      <button onclick="login()">ログイン</button>
    </div>
  </div>

  <!-- Admin Content -->
  <div id="adminContent">
    <div class="container">
      <!-- Pending Requests -->
      <div class="section">
        <h2>⏳ 未再生のリクエスト</h2>
        <div id="pendingList">
          <div class="spinner-inline"></div>
        </div>
      </div>

      <!-- Played Requests -->
      <div class="section">
        <h2>✅ 再生済みのリクエスト</h2>
        <div id="playedList">
          <div class="spinner-inline"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    const cfg = window.MUSIC_REQUEST_CONFIG || {};
    const BASE = cfg.GAS_BASE_URL || '';
    const ADMIN_KEY_LOCAL = 'music_admin_key';
    let ADMIN_KEY = '';
    let allRequests = [];

    if (!BASE) {
      alert('⚠️ 設定が未完了です（config.js を確認してください）');
    }

    function login() {
      const password = document.getElementById('adminPassword').value;
      const loginError = document.getElementById('loginError');

      // Simple client-side auth (should be password protected on GAS side too)
      if (password === 'seitokai2023') {
        ADMIN_KEY = password;
        localStorage.setItem(ADMIN_KEY_LOCAL, ADMIN_KEY);
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminContent').classList.add('visible');
        loadData();
      } else {
        loginError.textContent = 'パスワードが正しくありません';
      }
    }

    function logout() {
      ADMIN_KEY = '';
      localStorage.removeItem(ADMIN_KEY_LOCAL);
      location.reload();
    }

    async function loadData() {
      try {
        // Show spinners in both lists
        document.getElementById('pendingList').innerHTML = '<div class="spinner-inline"></div>';
        document.getElementById('playedList').innerHTML = '<div class="spinner-inline"></div>';

        const url = `${BASE}?mode=list`;
        const res = await fetch(url);
        const data = await res.json();
        
        console.log('Admin list data:', data);
        allRequests = Array.isArray(data) ? data : [];
        renderLists();
      } catch (err) {
        console.error('Load data error:', err);
        alert('データ読み込みエラー: ' + err.message);
      }
    }

    function renderLists() {
      const pending = allRequests.filter(r => r.status !== '再生済み');
      const played = allRequests.filter(r => r.status === '再生済み');

      renderTable('pendingList', pending, false);
      renderTable('playedList', played, true);
    }

    function renderTable(containerId, requests, isPlayed) {
      const container = document.getElementById(containerId);

      if (requests.length === 0) {
        container.innerHTML = '<div class="empty-msg">データがありません</div>';
        return;
      }

      let html = '<table><thead><tr><th>曲名</th><th>アーティスト</th><th>YouTube</th><th>投稿日時</th><th>操作</th></tr></thead><tbody>';

      requests.forEach(req => {
        const trClass = req.status === '再生済み' ? 'played' : '';
        const statusBadge = req.status === '再生済み' ? 
          '<span class="status status-played">再生済み</span>' : 
          '<span class="status status-pending">未再生</span>';

        html += `<tr class="${trClass}">
          <td>${escapeHtml(req.title)}</td>
          <td>${escapeHtml(req.artist)}</td>
          <td><a href="${escapeHtml(req.url)}" target="_blank" rel="noopener noreferrer" class="youtube-link">▶ YouTube で開く</a></td>
          <td style="font-size:12px;">${escapeHtml(req.timestamp)}</td>`;

        html += `<td>`;
        if (!isPlayed) {
          html += `<button class="action-btn" onclick="markAsPlayed(${req.rowIndex})">流した</button>`;
        }
        html += `<button class="delete-btn" onclick="deleteRequest(${req.rowIndex})">削除</button></td>`;

        html += '</tr>';
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    async function markAsPlayed(rowIndex) {
      try {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '処理中...';

        const form = new URLSearchParams();
        form.set('mode', 'update');
        form.set('rowIndex', rowIndex);
        form.set('adminKey', ADMIN_KEY);

        const res = await fetch(BASE, { method: 'POST', body: form });
        const data = await res.json();

        if (data && data.status === 'ok') {
          loadData();
        } else {
          alert('エラー: ' + (data.message || 'Unknown error'));
          btn.disabled = false;
          btn.textContent = '流した';
        }
      } catch (err) {
        alert('更新エラー: ' + err.message);
        btn.disabled = false;
        btn.textContent = '流した';
      }
    }

    function escapeHtml(text) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    async function deleteRequest(rowIndex) {
      if (!confirm('このリクエストを削除してもよろしいですか？')) return;

      try {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '削除中...';

        const form = new URLSearchParams();
        form.set('mode', 'delete');
        form.set('rowIndex', rowIndex);
        form.set('adminKey', ADMIN_KEY);

        const res = await fetch(BASE, { method: 'POST', body: form });
        const data = await res.json();

        if (data && data.status === 'ok') {
          loadData();
        } else {
          alert('削除エラー: ' + (data.message || 'Unknown error'));
          btn.disabled = false;
          btn.textContent = '削除';
        }
      } catch (err) {
        alert('削除エラー: ' + err.message);
        btn.disabled = false;
        btn.textContent = '削除';
      }
    }

    // Check for saved session
    const saved = localStorage.getItem(ADMIN_KEY_LOCAL);
    if (saved === 'admin2024') {
      ADMIN_KEY = saved;
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('adminContent').classList.add('visible');
      loadData();
    }

    // Allow Enter to login
    document.getElementById('adminPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });
  </script>
</body>
</html>
